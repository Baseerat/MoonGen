local dpdk		= require "dpdk"
local memory	= require "memory"
local device	= require "device"
local stats		= require "stats"
local timer		= require "timer"
local ffi     = require "ffi"

--memory.enableCache()

PKT_SIZE = 148
TX_RUN_TIME = 60

-- TODO: this
function master(port1, port2)
	if not port1 then
		return print("Usage: port1 [port2]")
	end
	local dev1 = device.config(port1)
	local dev2
	if port2 then
		dev2 = device.config(port2)
	end
	device.waitForLinks()
	local tx_task
	if port1 and port2 then
	  tx_task = dpdk.launchLua("txSlave2", dev1:getTxQueue(0), dev2:getTxQueue(0))
	else
	  tx_task = dpdk.launchLua("txSlave1", dev1:getTxQueue(0))
	end
	local avg = tx_task:wait()
	dpdk.waitForSlaves()
end

local function fillPacket1(buf)
  local data = ffi.cast("uint8_t*", buf:getData())
  local vxlan_pkt = {0x08, 0x00, 0x27, 0xf2, 0x1d, 0x8c, 0x08, 0x00, 0x27, 0xae, 0x4d, 0x62, 0x08, 0x00, 0x45, 0x00,
                     0x00, 0x86, 0xd9, 0x99, 0x40, 0x00, 0x40, 0x11, 0x6f, 0x65, 0xc0, 0xa8, 0x38, 0x0b, 0xc0, 0xa8,
                     0x38, 0x0c, 0xbc, 0x06, 0x12, 0xb5, 0x00, 0x72, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
                     0x7b, 0x00, 0x4a, 0x7f, 0x01, 0x3b, 0xa2, 0x71, 0xba, 0x09, 0x2b, 0x6e, 0xf8, 0xbe, 0x08, 0x00,
                     0x45, 0x00, 0x00, 0x54, 0x2f, 0x4f, 0x40, 0x00, 0x40, 0x01, 0xf7, 0x57, 0x0a, 0x00, 0x00, 0x01,
                     0x0a, 0x00, 0x00, 0x02, 0x08, 0x00, 0x4c, 0x8a, 0x0d, 0x3d, 0x00, 0x01, 0xa3, 0x8c, 0x7c, 0x57,
                     0x00, 0x00, 0x00, 0x00, 0xb5, 0x80, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x12, 0x13,
                     0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23,
                     0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33,
                     0x34, 0x35, 0x36, 0x37}
    for i = 0, PKT_SIZE-1 do
      data[i] = vxlan_pkt[i+1]
    end
end

local function fillPacket2(buf)
  local data = ffi.cast("uint8_t*", buf:getData())
  local vxlan_pkt = {0x08, 0x00, 0x27, 0xae, 0x4d, 0x62, 0x08, 0x00, 0x27, 0xf2, 0x1d, 0x8c, 0x08, 0x00, 0x45, 0x00,
                     0x00, 0x86, 0x97, 0x7f, 0x40, 0x00, 0x40, 0x11, 0xb1, 0x7f, 0xc0, 0xa8, 0x38, 0x0c, 0xc0, 0xa8,
                     0x38, 0x0b, 0x94, 0xb7, 0x12, 0xb5, 0x00, 0x72, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
                     0x7b, 0x00, 0xba, 0x09, 0x2b, 0x6e, 0xf8, 0xbe, 0x4a, 0x7f, 0x01, 0x3b, 0xa2, 0x71, 0x08, 0x00,
                     0x45, 0x00, 0x00, 0x54, 0x90, 0x31, 0x00, 0x00, 0x40, 0x01, 0xd6, 0x75, 0x0a, 0x00, 0x00, 0x02,
                     0x0a, 0x00, 0x00, 0x01, 0x00, 0x00, 0x54, 0x8a, 0x0d, 0x3d, 0x00, 0x01, 0xa3, 0x8c, 0x7c, 0x57,
                     0x00, 0x00, 0x00, 0x00, 0xb5, 0x80, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x12, 0x13,
                     0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23,
                     0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33,
                     0x34, 0x35, 0x36, 0x37}
    for i = 0, PKT_SIZE-1 do
      data[i] = vxlan_pkt[i+1]
    end
end

function txSlave1(queue1)
	local mem = memory.createMemPool(function(buf)
		fillPacket1(buf)
	end)
	bufs = mem:bufArray()
	bufs:alloc(PKT_SIZE)
	bufs:offloadIPChecksums()
	local ctr1 = stats:newDevTxCounter(queue1.dev, "plain")
	local runtime = timer:new(TX_RUN_TIME)
	while runtime:running() and dpdk.running() do
		queue1:send(bufs)
		ctr1:update()
	end
	ctr1:finalize()
	printf("Total Tx Mpps: %s (avg.), %s (stddev.)\r\nTotal Tx Mbps: %s (avg.), %s (stddev.)", ctr1.mpps.avg, ctr1.mpps.stdDev,
		ctr1.wireMbit.avg, ctr1.wireMbit.stdDev)
	return nil -- TODO
end

function txSlave2(queue1, queue2)
	local mem1 = memory.createMemPool(function(buf)
    fillPacket1(buf)
	end)
	local mem2 = memory.createMemPool(function(buf)
    fillPacket2(buf)
	end)
	bufs1 = mem1:bufArray()
	bufs1:alloc(PKT_SIZE)
	bufs1:offloadIPChecksums()
	bufs2 = mem2:bufArray()
	bufs2:alloc(PKT_SIZE)
	bufs2:offloadIPChecksums()
	local ctr1 = stats:newDevTxCounter(queue1.dev, "plain")
	local ctr2 = stats:newDevTxCounter(queue2.dev, "plain")
	local runtime = timer:new(TX_RUN_TIME)
	while runtime:running() and dpdk.running() do
		queue1:send(bufs1)
		ctr1:update()
		queue2:send(bufs2)
		ctr2:update()
	end
	ctr1:finalize()
	ctr2:finalize()
	printf("Total Tx Mpps: %s (avg.), %s (stddev.)\r\nTotal Tx Mbps: %s (avg.), %s (stddev.)",
		ctr1.mpps.avg + ctr2.mpps.avg, ctr1.mpps.stdDev + ctr2.mpps.stdDev,
		ctr1.wireMbit.avg + ctr2.wireMbit.avg, ctr1.wireMbit.stdDev + ctr2.wireMbit.stdDev)
	return nil -- TODO
end
